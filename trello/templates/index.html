{% load i18n %}
<!DOCTYPE html>
{% get_current_language as LANGUAGE_CODE %}
<html lang="{{ LANGUAGE_CODE }}" {% if LANGUAGE_CODE|slice:":2" == "fa" or LANGUAGE_CODE|slice:":2" == "ar" %}dir="rtl"{% endif %}>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans "Modern Trello" %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/vazir-font@33.0.0/dist/font-face.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
{% if LANGUAGE_CODE|slice:":2" == "fa" or LANGUAGE_CODE|slice:":2" == "ar" %}
body {
    font-family: 'Vazir', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    direction: rtl;
    text-align: right;
}
.header {
    flex-direction: row-reverse;
}
.header-buttons {
    flex-direction: row-reverse;
}
.auth-buttons {
    flex-direction: row-reverse;
}
.board-title {
    flex-direction: row-reverse;
}
.list-header {
    flex-direction: row-reverse;
}
.modal-header .btn-close {
    margin-left: auto;
    margin-right: 0;
}
.task-meta {
    flex-direction: row-reverse;
}
.color-picker-container {
    flex-direction: row-reverse;
}
.lists-wrapper {
    flex-direction: row-reverse;
}
.modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
}
.btn-close-white {
    filter: invert(1);
}
.invitation-item {
    flex-direction: row-reverse;
}
.invitation-actions {
    flex-direction: row-reverse;
}
.member-circle .tooltip {
    right: auto;
    left: 50%;
    transform: translateX(-50%);
}
.assigned-users {
    flex-direction: row-reverse;
}



{% else %}
.member-circle .tooltip {
    left: 50%;
    transform: translateX(-50%);
}
{% endif %}

:root {
    --primary-color: #026aa7;
    --primary-hover: #0052cc;
    --secondary-color: #f4f5f7;
    --success-color: #00875a;
    --danger-color: #FF0000;
    --danger-hover: #D10000;
    --text-color: #172b4d;
    --text-light: #6b808c;
    --border-radius: 12px;
    --box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    background: linear-gradient(135deg, #026aa7 0%, #0052cc 100%);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    color: var(--text-color);
    min-height: 100vh;
}

/* Header Styles */
.header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
    position: sticky;
    top: 0;
    z-index: 1000;
}

.header h3 {
    color: var(--primary-color);
    font-weight: 700;
    margin: 0;
}

.header-buttons {
    display: flex;
    gap: 0.5rem;
}

.modal-header .btn-close {
    margin-left: 0;
    margin-right: auto;
}

.header button {
    background: var(--primary-color);
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
}

.header button:hover {
    background: var(--primary-hover);
    transform: translateY(-2px);
}

.header button.btnlogout {
    background: var(--danger-color);
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
}

.header button.btnlogout:hover {
    background: var(--danger-hover);
    transform: translateY(-2px);
}

/* Welcome Page */
.welcome-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #026aa7 0%, #0052cc 100%);
    position: relative;
    overflow: hidden;
}

.welcome-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><radialGradient id="a" cx="50%" cy="50%"><stop offset="0%" stop-color="%23fff" stop-opacity="0.1"/><stop offset="100%" stop-color="%23fff" stop-opacity="0"/></radialGradient></defs><circle cx="200" cy="200" r="100" fill="url(%23a)"/><circle cx="800" cy="300" r="150" fill="url(%23a)"/><circle cx="400" cy="700" r="120" fill="url(%23a)"/></svg>') no-repeat center;
    background-size: cover;
}

.welcome-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 24px;
    padding: 2.5rem;
    box-shadow: var(--box-shadow);
    text-align: center;
    max-width: 500px;
    margin: 1rem;
    position: relative;
    z-index: 1;
    animation: fadeInUp 0.8s ease-out;
    margin-bottom: 50px;
}

.welcome-logo {
    font-size: 4rem;
    color: var(--primary-color);
    margin-bottom: 1rem;
    animation: bounce 2s infinite;
}

.welcome-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--text-color);
    margin-bottom: 1rem;
}

.welcome-subtitle {
    font-size: 1.2rem;
    color: var(--text-light);
    margin-bottom: 2rem;
}

.auth-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
}

.auth-btn {
    background: var(--primary-color);
    color: white;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.auth-btn:hover {
    background: var(--primary-hover);
    transform: translateY(-2px);
    color: white;
}

.auth-btn.secondary {
    background: transparent;
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
}

.auth-btn.secondary:hover {
    background: var(--primary-color);
    color: white;
}

/* Auth Forms Container */
#auth-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #026aa7 0%, #0052cc 100%);
    padding: 2rem 0;
}

/* Auth Forms */
.auth-card {
    max-width: 400px;
    margin: 0 auto;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 24px;
    padding: 2rem;
    box-shadow: var(--box-shadow);
    animation: fadeInUp 0.5s ease-out;
}

.auth-card h4 {
    text-align: center;
    margin-bottom: 1.5rem;
    color: var(--text-color);
    font-weight: 700;
}

#back-to-boards-btn i {
    vertical-align: middle;
    margin-top: 5px;
    padding-right: 6px;
}

.form-floating {
    margin-bottom: 1rem;
}

.form-control {
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-radius: 12px;
    padding: 0.75rem;
    transition: var(--transition);
    font-size: 1rem;
}

.form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.25rem rgba(2, 106, 167, 0.15);
}

.form-select {
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-radius: 12px;
    padding: 0.75rem;
    padding-right: 35px;
}

/* Board Selection */
.boards-container {
    min-height: calc(100vh - 80px);
    padding: 2rem;
    background: var(--secondary-color);
}

.boards-header {
    text-align: center;
    margin-bottom: 2rem;
}

.boards-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--text-color);
    margin-bottom: 0.5rem;
}

.boards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.board-card {
    background: white;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    box-shadow: var(--box-shadow);
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.board-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--primary-color);
}

.board-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15);
}

.board-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.board-meta {
    color: var(--text-light);
    font-size: 0.9rem;
}

.create-board-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: var(--border-radius);
    padding: 2rem;
    box-shadow: var(--box-shadow);
    max-width: 500px;
    margin: 0 auto;
}

.color-picker-container {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.color-option {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid transparent;
    cursor: pointer;
    transition: var(--transition);
}

.color-option:hover,
.color-option.active {
    border-color: white;
    box-shadow: 0 0 0 2px var(--primary-color);
    transform: scale(1.1);
}

/* Board View */
.board-container {
    min-height: calc(100vh - 80px);
    padding: 1rem;
    overflow-x: auto;
    overflow-y: hidden;
}

.lists-wrapper {
    display: flex;
    gap: 1rem;
    padding-bottom: 1rem;
    min-height: calc(100vh - 120px);
    width: max-content;
    align-items: flex-start;
}

#lists-container {
    display: flex;
    flex-direction: row;
    gap: 1rem;
    align-items: flex-start;
}

.list-column {
    background: rgba(235, 236, 240, 0.95);
    backdrop-filter: blur(10px);
    border-radius: var(--border-radius);
    width: 300px;
    min-width: 300px;
    padding: 1rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    transition: var(--transition);
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
}

.list-column:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}

.list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding: 0.5rem;
    border-bottom: 2px solid rgba(0, 0, 0, 0.1);
}

.list-title {
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
}

.task-list {
    min-height: 100px;
    list-style: none;
    padding: 0;
    margin: 0;
    flex-grow: 1;
}

.task-card {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    cursor: grab;
    transition: var(--transition);
    border-left: 4px solid var(--primary-color);
}

.task-card:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.task-card:active {
    cursor: grabbing;
}

.task-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.task-meta {
    font-size: 0.85rem;
    color: var(--text-light);
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.add-list-btn,
.add-task-btn {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 2px dashed rgba(255, 255, 255, 0.5);
    border-radius: var(--border-radius);
    color: rgba(255, 255, 255, 0.8);
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-weight: 500;
}

.add-list-btn {
    width: 300px;
    min-width: 300px;
    height: 120px;
    flex-shrink: 0;
}

.add-task-btn {
    width: 100%;
    margin-top: 0.5rem;
    padding: 0.75rem;
    border-color: rgba(91, 200, 230, 0.8);
    color: #414141ff;
}

.add-list-btn:hover,
.add-task-btn:hover {
    background: rgba(67, 67, 67, 0.3);
    border-color: rgba(18, 137, 170, 0.8);
    color: #414141ff;
}

/* Modal Styles */
.modal-content {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    animation: fadeInUp 0.5s ease-out;
}

.modal-header {
    background: linear-gradient(90deg, var(--primary-color), var(--primary-hover));
    color: white;
    border-radius: var(--border-radius) var(--border-radius) 0 0;
    padding: 1.5rem;
}

.modal-title {
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.modal-body {
    padding: 1.5rem;
}

.task-detail-text {
    background: var(--secondary-color);
    padding: 0.75rem;
    border-radius: 8px;
    margin: 0;
    border-left: 4px solid var(--primary-color);
}

.task-detail-text:empty::before {
    content: 'No information available';
    color: var(--text-light);
    font-style: italic;
}

/* Footer */
.footer {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    text-align: center;
    padding: 1rem;
    font-size: 0.9rem;
    color: var(--text-light);
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    margin-top: auto;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 999;
}

/* Animations */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
    }
    40% {
        transform: translateY(-10px);
    }
    60% {
        transform: translateY(-5px);
    }
}

.sortable-ghost {
    opacity: 0.5;
}

/* Invitation List Styles */
.invitation-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: var(--secondary-color);
    border-radius: 8px;
    margin-bottom: 0.75rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: var(--transition);
}

.invitation-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.invitation-status-pending {
    color: #d39e00;
    font-weight: 500;
}

.invitation-status-accepted {
    color: var(--success-color);
    font-weight: 500;
}

.invitation-status-rejected {
    color: var(--danger-color);
    font-weight: 500;
}

.invitation-actions {
    display: flex;
    gap: 0.5rem;
}

/* Board Members Styles */
.board-members {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    flex-wrap: wrap;
}

.member-circle {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    font-weight: 600;
    position: relative;
    cursor: pointer;
    transition: var(--transition);
}

.member-circle:hover {
    transform: scale(1.1);
}

.member-circle .tooltip {
    visibility: hidden;
    opacity: 0;
    background: var(--text-color);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    position: absolute;
    top: -40px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    font-size: 0.8rem;
    white-space: nowrap;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    transition: opacity 0.2s ease, visibility 0.2s ease;
}

.member-circle .tooltip::after {
    content: '';
    position: absolute;
    bottom: -6px;
    left: 50%;
    transform: translateX(-50%);
    border-width: 6px;
    border-style: solid;
    border-color: var(--text-color) transparent transparent transparent;
}

.member-circle:hover .tooltip {
    visibility: visible;
    opacity: 1;
}

/* Task Assign Styles */
.assign-users-container {
    margin-top: 1rem;
}

.assign-users-select {
    width: 100%;
    padding: 0.75rem;
    border-radius: 8px;
    border: 2px solid rgba(0, 0, 0, 0.1);
}

.assign-users-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.25rem rgba(2, 106, 167, 0.15);
}

.assigned-users {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 0.5rem;
}

.assigned-user-chip {
    background: #43af04ff;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 16px;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.assigned-user-chip .remove-user {
    cursor: pointer;
    font-size: 0.9rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .header {
        padding: 1rem;
        flex-wrap: wrap;
    }

    .header-buttons {
        margin-top: 0.5rem;
    }

    .welcome-card {
        margin: 1rem;
        padding: 2rem;
    }

    .welcome-title {
        font-size: 2rem;
    }

    .auth-buttons {
        flex-direction: column;
    }

    .boards-container {
        padding: 1rem;
    }

    .boards-grid {
        grid-template-columns: 1fr;
    }

    .board-container {
        padding: 0.5rem;
    }

    .lists-wrapper {
        gap: 1rem;
        flex-direction: row;
    }

    .list-column {
        width: 280px;
        min-width: 280px;
        flex-shrink: 0;
    }

    .add-list-btn {
        width: 280px;
        min-width: 280px;
        flex-shrink: 0;
    }

    .color-picker-container {
        justify-content: center;
    }

    .member-circle .tooltip {
        font-size: 0.75rem;
        padding: 0.4rem 0.8rem;
        top: -35px;
    }
}



    /* User Profile Modal Styles */
    #userProfileModal .modal-body {
        padding: 1.5rem;
    }

    #userProfileModal .task-detail-text {
        background: var(--secondary-color);
        padding: 0.75rem;
        border-radius: 8px;
        margin: 0;
        border-left: 4px solid var(--primary-color);
    }

    #userProfileModal .task-detail-text:empty::before {
        content: '{% trans "No information available" %}';
        color: var(--text-light);
        font-style: italic;
    }

@media (max-width: 480px) {
    .welcome-card {
        padding: 1.5rem;
    }

    .auth-card {
        margin: 1rem;
        padding: 1.5rem;
    }

    .task-meta {
        flex-direction: column;
        gap: 0.25rem;
    }

    .member-circle .tooltip {
        font-size: 0.7rem;
        padding: 0.3rem 0.6rem;
        top: -30px;
    }

    .member-circle .tooltip::after {
        border-width: 5px;
        bottom: -5px;
    }
}

    </style>
</head>
<body>
 <!-- Header -->
    <header class="header" style="display: none;" id="app-header">
        
        <select id="header-language-select" class="form-select" style="width: auto; margin-left: 1rem;" onchange="changeLanguage(this.value)">
            <option value="en" {% if LANGUAGE_CODE == "en" %}selected{% endif %}>ðŸ‡ºðŸ‡¸ {% trans "English" %}</option>
            <option value="fa" {% if LANGUAGE_CODE == "fa" %}selected{% endif %}>ðŸ‡®ðŸ‡· {% trans "Persian" %}</option>
            <option value="ar" {% if LANGUAGE_CODE == "ar" %}selected{% endif %}>ðŸ‡¸ðŸ‡¦ {% trans "Arabic" %}</option>
            <option value="de" {% if LANGUAGE_CODE == "de" %}selected{% endif %}>ðŸ‡©ðŸ‡ª {% trans "German" %}</option>
            <option value="fr" {% if LANGUAGE_CODE == "fr" %}selected{% endif %}>ðŸ‡«ðŸ‡· {% trans "French" %}</option>
            <option value="it" {% if LANGUAGE_CODE == "it" %}selected{% endif %}>ðŸ‡®ðŸ‡¹ {% trans "Italian" %}</option>
            <option value="hi" {% if LANGUAGE_CODE == "hi" %}selected{% endif %}>ðŸ‡®ðŸ‡³ {% trans "Hindi" %}</option>
            <option value="ko" {% if LANGUAGE_CODE == "ko" %}selected{% endif %}>ðŸ‡°ðŸ‡· {% trans "Korean" %}</option>
            <option value="ja" {% if LANGUAGE_CODE == "ja" %}selected{% endif %}>ðŸ‡¯ðŸ‡µ {% trans "Japanese" %}</option>
            <option value="ru" {% if LANGUAGE_CODE == "ru" %}selected{% endif %}>ðŸ‡·ðŸ‡º {% trans "Russian" %}</option>
            <option value="tr" {% if LANGUAGE_CODE == "tr" %}selected{% endif %}>ðŸ‡¹ðŸ‡· {% trans "Turkish" %}</option>
            <option value="es" {% if LANGUAGE_CODE == "es" %}selected{% endif %}>ðŸ‡ªðŸ‡¸ {% trans "Spanish" %}</option>
        </select>
        <button onclick="showUserProfileModal()" class="btn btn-primary btn-sm"  >
            <i class="fas fa-user"></i> {% trans "Profile" %}
        </button>
        <h3><i class="fas fa-columns"></i> {% trans "Modern Trello" %}</h3>
        <div class="header-buttons">
            <button onclick="showInviteMemberModal()" class="btn btn-primary btn-sm">
                <i class="fas fa-user-plus"></i> {% trans "Invite Member" %}
            </button>
            <button onclick="showInvitationsModal()" class="btn btn-primary btn-sm">
                <i class="fas fa-envelope"></i> {% trans "Invitations" %}
            </button>
            <button id="back-to-boards-btn" onclick="backToBoards()">
                <i class="fas fa-arrow-left"></i> {% trans "Back to Boards" %}
            </button>
            <button onclick="logout()" class="btnlogout">
                <i class="fas fa-sign-out-alt"></i> {% trans "Logout" %}
            </button>
        </div>
    </header>

    <!-- Welcome Page -->
    <div id="welcome-page" class="welcome-container">
        <div class="welcome-card">
            <div class="welcome-logo">
                <i class="fas fa-columns"></i>
            </div>
            <h1 class="welcome-title">{% trans "Welcome to Modern Trello" %}</h1>
            <p class="welcome-subtitle">{% trans "Organize anything, together. The easy, flexible way to manage your projects." %}</p>
            <div class="auth-buttons">
                <button class="auth-btn" onclick="showLogin()">
                    <i class="fas fa-sign-in-alt"></i> {% trans "Login" %}
                </button>
                <button class="auth-btn secondary" onclick="showRegister()">
                    <i class="fas fa-user-plus"></i> {% trans "Sign Up" %}
                </button>
            </div>
            <div class="form-floating mt-3">
                <select id="welcome-language-select" class="form-select" onchange="changeLanguage(this.value)">
                    <option value="en" {% if LANGUAGE_CODE == "en" %}selected{% endif %}>ðŸ‡ºðŸ‡¸ {% trans "English" %}</option>
                    <option value="fa" {% if LANGUAGE_CODE == "fa" %}selected{% endif %}>ðŸ‡®ðŸ‡· {% trans "Persian" %}</option>
                    <option value="ar" {% if LANGUAGE_CODE == "ar" %}selected{% endif %}>ðŸ‡¸ðŸ‡¦ {% trans "Arabic" %}</option>
                    <option value="de" {% if LANGUAGE_CODE == "de" %}selected{% endif %}>ðŸ‡©ðŸ‡ª {% trans "German" %}</option>
                    <option value="fr" {% if LANGUAGE_CODE == "fr" %}selected{% endif %}>ðŸ‡«ðŸ‡· {% trans "French" %}</option>
                    <option value="it" {% if LANGUAGE_CODE == "it" %}selected{% endif %}>ðŸ‡®ðŸ‡¹ {% trans "Italian" %}</option>
                    <option value="hi" {% if LANGUAGE_CODE == "hi" %}selected{% endif %}>ðŸ‡®ðŸ‡³ {% trans "Hindi" %}</option>
                    <option value="ko" {% if LANGUAGE_CODE == "ko" %}selected{% endif %}>ðŸ‡°ðŸ‡· {% trans "Korean" %}</option>
                    <option value="ja" {% if LANGUAGE_CODE == "ja" %}selected{% endif %}>ðŸ‡¯ðŸ‡µ {% trans "Japanese" %}</option>
                    <option value="ru" {% if LANGUAGE_CODE == "ru" %}selected{% endif %}>ðŸ‡·ðŸ‡º {% trans "Russian" %}</option>
                    <option value="tr" {% if LANGUAGE_CODE == "tr" %}selected{% endif %}>ðŸ‡¹ðŸ‡· {% trans "Turkish" %}</option>
                    <option value="es" {% if LANGUAGE_CODE == "es" %}selected{% endif %}>ðŸ‡ªðŸ‡¸ {% trans "Spanish" %}</option>
                </select>
                <label>{% trans "Select Language" %}</label>
            </div>
        </div>
    </div>

    <!-- Auth Forms Container -->
    <div id="auth-container" style="display: none;">
        <!-- Login Form -->
        <div id="login-card" class="auth-card" style="display: none;">
            <h4><i class="fas fa-sign-in-alt"></i> {% trans "Welcome Back" %}</h4>
            <div class="form-floating">
                <input type="text" id="login-username" class="form-control" placeholder="Username">
                <label>{% trans "Username" %}</label>
            </div>
            <div class="form-floating">
                <input type="password" id="login-password" class="form-control" placeholder="Password">
                <label>{% trans "Password" %}</label>
            </div>
            <button onclick="login()" class="btn btn-primary w-100 mb-3">
                <i class="fas fa-sign-in-alt"></i> {% trans "Login" %}
            </button>
            <div class="text-center">
                <a href="#" onclick="showRegister()" class="text-decoration-none">{% trans "Don't have an account? Sign up" %}</a>
            </div>
        </div>

        <!-- Register Form -->
        <div id="register-card" class="auth-card" style="display: none;">
            <h4><i class="fas fa-user-plus"></i> {% trans "Create Account" %}</h4>
            <div class="form-floating">
                <input type="text" id="register-username" class="form-control" placeholder="Username">
                <label>{% trans "Username" %}</label>
            </div>
            <div class="form-floating">
                <input type="email" id="register-email" class="form-control" placeholder="Email">
                <label>{% trans "Email" %}</label>
            </div>
            <div class="form-floating">
                <input type="password" id="register-password" class="form-control" placeholder="Password">
                <label>{% trans "Password" %}</label>
            </div>
            <div class="form-floating">
                <input type="text" id="register-name" class="form-control" placeholder="Full Name">
                <label>{% trans "Full Name" %}</label>
            </div>
            <div class="form-floating">
                <select id="register-language" class="form-select">
                    <option value="en">ðŸ‡ºðŸ‡¸ {% trans "English" %}</option>
                    <option value="fa">ðŸ‡®ðŸ‡· {% trans "Persian" %}</option>
                    <option value="ar">ðŸ‡¸ðŸ‡¦ {% trans "Arabic" %}</option>
                    <option value="de">ðŸ‡©ðŸ‡ª {% trans "German" %}</option>
                    <option value="fr">ðŸ‡«ðŸ‡· {% trans "French" %}</option>
                    <option value="it">ðŸ‡®ðŸ‡¹ {% trans "Italian" %}</option>
                    <option value="hi">ðŸ‡®ðŸ‡³ {% trans "Hindi" %}</option>
                    <option value="ko">ðŸ‡°ðŸ‡· {% trans "Korean" %}</option>
                    <option value="ja">ðŸ‡¯ðŸ‡µ {% trans "Japanese" %}</option>
                    <option value="ru">ðŸ‡·ðŸ‡º {% trans "Russian" %}</option>
                    <option value="tr">ðŸ‡¹ðŸ‡· {% trans "Turkish" %}</option>
                    <option value="es">ðŸ‡ªðŸ‡¸ {% trans "Spanish" %}</option>
                </select>
                <label>{% trans "Language" %}</label>
            </div>
            <button onclick="register()" class="btn btn-primary w-100 mb-3">
                <i class="fas fa-user-plus"></i> {% trans "Create Account" %}
            </button>
            <div class="text-center">
                <a href="#" onclick="showLogin()" class="text-decoration-none">{% trans "Already have an account? Login" %}</a>
            </div>
        </div>
    </div>

    <!-- Board Selection -->
    <div id="board-selection" style="display: none;" class="boards-container">
        <div class="boards-header">
            <h2 class="boards-title" ><i class="fas fa-th-large"></i> {% trans "Your Boards" %}</h2>
            <p class="text-muted">{% trans "Select a board to get started, or create a new one" %}</p>
        </div>
        
        <div class="boards-grid" id="boards-grid"></div>
        
        <div class="create-board-card">
            <h5 class="mb-3"><i class="fas fa-plus"></i> {% trans "Create New Board" %}</h5>
            <div class="form-floating mb-3">
                <input type="text" id="board-title" class="form-control" placeholder="Board Title">
                <label >{% trans "Board Title" %}</label>
            </div>
            <div class="mb-3">
                <label class="form-label">{% trans "Choose Color" %}</label>
                <div class="color-picker-container" id="color-picker">
                    <div class="color-option active" data-color="#0079bf" style="background: #0079bf;"></div>
                    <div class="color-option" data-color="#d29034" style="background: #d29034;"></div>
                    <div class="color-option" data-color="#519839" style="background: #519839;"></div>
                    <div class="color-option" data-color="#b04632" style="background: #b04632;"></div>
                    <div class="color-option" data-color="#89609e" style="background: #89609e;"></div>
                    <div class="color-option" data-color="#cd5a91" style="background: #cd5a91;"></div>
                    <div class="color-option" data-color="#4bbf6b" style="background: #4bbf6b;"></div>
                    <div class="color-option" data-color="#00aecc" style="background: #00aecc;"></div>
                </div>
            </div>
            <button onclick="createBoard()" class="btn btn-success w-100">
                <i class="fas fa-plus"></i> {% trans "Create Board" %}
            </button>
        </div>
    </div>

    <!-- Board View -->
    <div id="trello-board" style="display: none;" class="board-container">
        <div class="lists-wrapper" id="lists-wrapper">
            <div id="lists-container"></div>
            <div class="add-list-btn" onclick="showAddListModal()">
                <i class="fas fa-plus"></i> {% trans "Add List" %}
            </div>
        </div>
    </div>

    <!-- Add List Modal -->
    <div class="modal fade" id="addListModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{% trans "Add New List" %}</h5>
                    <button type="button" class="btn-close btn-close-white " data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="form-floating">
                        <input type="text" id="list-title-input" class="form-control" placeholder="List Title">
                        <label>{% trans "List Title" %}</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="button" class="btn btn-primary" onclick="addList()">{% trans "Add List" %}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal fade" id="addTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{% trans "Add New Task" %}</h5>
                    <button type="button" class="btn-close btn-close-white " data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="form-floating mb-3">
                        <input type="text" id="task-title-input" class="form-control" placeholder="Task Title">
                        <label>{% trans "Task Title" %}</label>
                    </div>
                    <div class="form-floating mb-3">
                        <textarea id="task-description-input" class="form-control" placeholder="Task Description" style="height: 100px"></textarea>
                        <label>{% trans "Task Description" %}</label>
                    </div>
                    <div class="form-floating">
                        <input type="datetime-local" id="task-due-date-input" class="form-control">
                        <label>{% trans "Due Date (Optional)" %}</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="button" class="btn btn-primary" onclick="addTask()">{% trans "Add Task" %}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Details Modal -->
    <div class="modal fade" id="taskDetailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="task-details-title"><i class="fas fa-task"></i> {% trans "Task Details" %}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6><i class="fas fa-heading"></i> {% trans "Title" %}</h6>
                        <p id="task-details-title-text" class="task-detail-text"></p>
                    </div>
                    <div class="mb-3">
                        <h6><i class="fas fa-align-left"></i> {% trans "Description" %}</h6>
                        <p id="task-details-description" class="task-detail-text"></p>
                    </div>
                    <div class="mb-3">
                        <h6><i class="fas fa-calendar"></i> {% trans "Due Date" %}</h6>
                        <p id="task-details-due-date" class="task-detail-text"></p>
                    </div>
                    <div class="mb-3">
                        <h6><i class="fas fa-list"></i> {% trans "List" %}</h6>
                        <p id="task-details-list" class="task-detail-text"></p>
                    </div>
                    <div class="mb-3">
                        <h6><i class="fas fa-clock"></i> {% trans "Created" %}</h6>
                        <p id="task-details-created" class="task-detail-text"></p>
                    </div>
                    <div class="mb-3 assign-users-container">
                        <h6><i class="fas fa-users"></i> {% trans "Assigned Users" %}</h6>
                        <div id="assigned-users" class="assigned-users"></div>
                        <select id="assign-users-select" class="assign-users-select mt-2">
                            <option value="">{% trans "Select user to assign" %}</option>
                        </select>
                        <button class="btn btn-primary btn-sm mt-2" onclick="assignUser(currentTaskForDetails.id)">
                            <i class="fas fa-user-plus"></i> {% trans "Assign User" %}
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="deleteTask()">
                        <i class="fas fa-trash"></i> {% trans "Delete Task" %}
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invite Member Modal -->
    <div class="modal fade" id="inviteMemberModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-plus"></i> {% trans "Invite to Board" %}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="form-floating mb-3">
                        <select id="invite-board-select" class="form-select">
                            <option value="">{% trans "Select Board" %}</option>
                        </select>
                        <label>{% trans "Select Board" %}</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="email" id="invite-email-input" class="form-control" placeholder="{% trans 'Email' %}">
                        <label>{% trans "User Email" %}</label>
                    </div>
                    <div id="invite-error" class="text-danger" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="button" class="btn btn-primary" onclick="sendInvitation()"><i class="fas fa-paper-plane"></i> {% trans "Send Invite" %}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invitations Management Modal -->
    <div class="modal fade" id="invitationsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-envelope"></i> {% trans "Manage Invitations" %}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="sent-tab" data-bs-toggle="tab" data-bs-target="#sent-invitations" type="button" role="tab">{% trans "Sent Invitations" %}</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="received-tab" data-bs-toggle="tab" data-bs-target="#received-invitations" type="button" role="tab">{% trans "Received Invitations" %}</button>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="sent-invitations" role="tabpanel">
                            <div id="sent-invitations-list"></div>
                        </div>
                        <div class="tab-pane fade" id="received-invitations" role="tabpanel">
                            <div id="received-invitations-list"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div class="modal fade" id="userProfileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user"></i> {% trans "User Profile" %}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6><i class="fas fa-user-circle"></i> {% trans "Username" %}</h6>
                        <p id="profile-username" class="task-detail-text"></p>
                    </div>
                    <div class="mb-3">
                        <h6><i class="fas fa-envelope"></i> {% trans "Email" %}</h6>
                        <p id="profile-email" class="task-detail-text"></p>
                    </div>
                    <div class="mb-3">
                        <h6><i class="fas fa-signature"></i> {% trans "Name" %}</h6>
                        <p id="profile-name" class="task-detail-text"></p>
                    </div>
                    <div class="mb-3">
                        <h6><i class="fas fa-language"></i> {% trans "Preferred Language" %}</h6>
                        <p id="profile-language" class="task-detail-text"></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
                </div>
            </div>
        </div>
    </div>



    <!-- Footer -->
    <footer class="footer" id="app-footer">
        <p><i class="fas fa-heart text-danger"></i> {% trans "Made with Modern Design" %} â€¢ Â© 2025 {% trans "Modern Trello" %}</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    

<script>
let accessToken = '';
let currentBoardId = null;
let currentBoardColor = '#0079bf';
let selectedColor = '#0079bf';
let currentListId = null;
let currentTaskForDetails = null;

// i18n
let currentUserLanguage = 'en';
let translations = {};
let userInfo = null;

// Function to load translations from server
async function loadTranslations() {
    try {
        const headers = {
            'Accept-Language': currentUserLanguage
        };
        
        if (accessToken) {
            headers['Authorization'] = `Bearer ${accessToken}`;
        }

        const response = await fetch('http://localhost:8000/users/test-translation/', {
            headers: headers
        });
        
        if (response.ok) {
            const data = await response.json();
            translations = data.translations || {};
            currentUserLanguage = data.current_language || currentUserLanguage;
            
            setPageLanguage(currentUserLanguage);
            
            return true;
        } else {
            console.warn('Could not load translations, using defaults');
        }
    } catch (error) {
        console.error('Error loading translations:', error);
    }
    return false;
}

// Function to get translation
function getTranslation(key, fallback = key) {
    return translations[key] || fallback || key;
}

// Function to set page language
function setPageLanguage(language) {
    const html = document.documentElement;
    const body = document.body;
    
    html.setAttribute('lang', language);
    
    if (language === 'fa' || language === 'ar') {
        html.setAttribute('dir', 'rtl');
        body.classList.add('rtl-language');
    } else {
        html.setAttribute('dir', 'ltr');
        body.classList.remove('rtl-language');
    }
    
    if (language === 'fa') {
        body.style.fontFamily = "'Vazir', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
    } else {
        body.style.fontFamily = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
    }
}

// Function to load user's saved language
function loadUserLanguage() {
    const savedLanguage = localStorage.getItem('userLanguage');
    const userData = localStorage.getItem('userData');
    
    if (userData) {
        try {
            const user = JSON.parse(userData);
            userInfo = user;
            currentUserLanguage = user.preferred_language || savedLanguage || 'en';
        } catch (error) {
            currentUserLanguage = savedLanguage || 'en';
        }
    } else {
        currentUserLanguage = savedLanguage || 'en';
    }
    
    setPageLanguage(currentUserLanguage);
    return currentUserLanguage;
}

// Initialize app
async function initApp() {
    accessToken = localStorage.getItem('accessToken') || '';
    
    loadUserLanguage();
    
    if (accessToken) {
        await loadTranslations();
        showBoardSelection();
    } else {
        await loadTranslations();
        showWelcomePage();
    }

    setupColorPicker();
    
    // Add event listener for page refresh
    window.addEventListener('beforeunload', () => {
        localStorage.setItem('lastBoardId', currentBoardId || '');
    });
}

// Page Navigation
function showWelcomePage() {
    hideAllPages();
    document.getElementById('welcome-page').style.display = 'flex';
    document.getElementById('app-header').style.display = 'none';
    document.getElementById('app-footer').style.display = 'block';
}

function showAuthContainer() {
    hideAllPages();
    document.getElementById('auth-container').style.display = 'flex';
    document.getElementById('app-header').style.display = 'none';
    document.getElementById('app-footer').style.display = 'none';
}

function showBoardSelection() {
    hideAllPages();
    document.getElementById('board-selection').style.display = 'block';
    document.getElementById('app-header').style.display = 'flex';
    document.getElementById('back-to-boards-btn').style.display = 'none';
    document.getElementById('app-footer').style.display = 'block';
    document.body.style.background = 'var(--secondary-color)';
    loadBoards();
}

function showTrelloBoard() {
    hideAllPages();
    document.getElementById('trello-board').style.display = 'block';
    document.getElementById('app-header').style.display = 'flex';
    document.getElementById('back-to-boards-btn').style.display = 'inline-flex';
    document.getElementById('app-footer').style.display = 'none';
    document.body.style.background = currentBoardColor;
}

function hideAllPages() {
    document.getElementById('welcome-page').style.display = 'none';
    document.getElementById('auth-container').style.display = 'none';
    document.getElementById('board-selection').style.display = 'none';
    document.getElementById('trello-board').style.display = 'none';
}

// Auth Functions
function showLogin() {
    showAuthContainer();
    document.getElementById('login-card').style.display = 'block';
    document.getElementById('register-card').style.display = 'none';
}

function showRegister() {
    showAuthContainer();
    document.getElementById('login-card').style.display = 'none';
    document.getElementById('register-card').style.display = 'block';
}

async function login() {
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;
    
    if (!username || !password) {
        Swal.fire({
            icon: 'warning',
            title: getTranslation('please_fill_all_fields', 'Please fill in all fields'),
            confirmButtonText: getTranslation('ok', 'OK')
        });
        return;
    }

    try {
        const response = await fetch('http://localhost:8000/api/token/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });

        if (!response.ok) {
            throw new Error(getTranslation('invalid_credentials', 'Invalid credentials'));
        }

        const data = await response.json();
        accessToken = data.access;
        localStorage.setItem('accessToken', accessToken);

        if (data.user) {
            userInfo = data.user;
            currentUserLanguage = data.user.preferred_language || 'en';
            localStorage.setItem('userLanguage', currentUserLanguage);
            localStorage.setItem('userData', JSON.stringify(data.user));
        } else {

            await loadUserProfile();
        }

        await loadTranslations();
        
        showBoardSelection();
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: getTranslation('login_failed', 'Login failed'),
            text: error.message,
            confirmButtonText: getTranslation('ok', 'OK')
        });
    }
}

async function loadUserProfile() {
    try {
        const response = await fetch('http://localhost:8000/users/profile/', {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });

        if (response.ok) {
            const userData = await response.json();
            userInfo = userData;
            currentUserLanguage = userData.preferred_language || 'en';
            localStorage.setItem('userLanguage', currentUserLanguage);
            localStorage.setItem('userData', JSON.stringify(userData));
        }
    } catch (error) {
        console.error('Error loading user profile:', error);
    }
}

async function register() {
    const username = document.getElementById('register-username').value;
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    const name = document.getElementById('register-name').value;
    const language = document.getElementById('register-language').value;
    
    if (!username || !email || !password || !name) {
        Swal.fire({
            icon: 'warning',
            title: getTranslation('please_fill_required_fields', 'Please fill in all required fields'),
            confirmButtonText: getTranslation('ok', 'OK')
        });
        return;
    }

    try {
        const response = await fetch('http://localhost:8000/users/register/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                username, 
                email, 
                password, 
                name, 
                preferred_language: language 
            })
        });

        if (!response.ok) {
            throw new Error(getTranslation('registration_failed', 'Registration failed'));
        }

        const data = await response.json();

        currentUserLanguage = language;
        localStorage.setItem('userLanguage', language);
        
        await loadTranslations();

        Swal.fire({
            icon: 'success',
            title: getTranslation('registration_successful', 'Registration successful! Please login.'),
            confirmButtonText: getTranslation('ok', 'OK')
        }).then(() => {
            showLogin();
        });
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: getTranslation('registration_failed', 'Registration failed'),
            text: error.message,
            confirmButtonText: getTranslation('ok', 'OK')
        });
    }
}

function logout() {
    localStorage.removeItem('accessToken');
    localStorage.removeItem('lastBoardId');
    localStorage.removeItem('userLanguage');
    localStorage.removeItem('userData');
    accessToken = '';
    currentBoardId = null;
    currentUserLanguage = 'en';
    translations = {};
    userInfo = null;
    
    setPageLanguage('en');
    
    showWelcomePage();
}

function backToBoards() {
    currentBoardId = null;
    showBoardSelection();
}

// Board Management
function loadBoards() {
    fetch('http://localhost:8000/boards/', {
        headers: { 'Authorization': `Bearer ${accessToken}` }
    })
    .then(response => {
        if (!response.ok) {
            if (response.status === 401) {
                logout();
                throw new Error(getTranslation('unauthorized', 'Unauthorized'));
            }
            throw new Error(getTranslation('failed_load_boards', 'Failed to load boards'));
        }
        return response.json();
    })
    .then(data => {
        const boardsGrid = document.getElementById('boards-grid');
        boardsGrid.innerHTML = '';
        
        data.forEach(board => {
            const boardCard = document.createElement('div');
            boardCard.className = 'board-card';
            boardCard.style.setProperty('--primary-color', board.color);
            let membersHtml = '<div class="board-members">';
            board.members.forEach(member => {
                const initial = (member.name || member.username).charAt(0).toUpperCase();
                membersHtml += `
                    <div class="member-circle" data-member-id="${member.id}">
                        ${initial}
                        <span class="tooltip">${member.name || member.username}</span>
                    </div>
                `;
            });
            membersHtml += '</div>';
            boardCard.innerHTML = `
                <div class="board-title">
                    <span>${board.title}</span>
                    <button class="btn btn-danger btn-sm" onclick="deleteBoard(event, ${board.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="board-meta">
                    <i class="fas fa-calendar"></i> ${getTranslation('created_recently', 'Created recently')}
                </div>
                ${membersHtml}
            `;
            boardCard.addEventListener('click', (e) => {
                if (!e.target.closest('.btn-danger') && !e.target.closest('.member-circle')) {
                    openBoard(board.id, board.color);
                }
            });
            boardsGrid.appendChild(boardCard);
        });
    })
    .catch(error => {
        if (!error.message.includes('Unauthorized')) {
            Swal.fire({
                icon: 'error',
                title: getTranslation('error_loading_boards', 'Error loading boards'),
                text: error.message,
                confirmButtonText: getTranslation('ok', 'OK')
            });
        }
    });
}

function setupColorPicker() {
    const colorOptions = document.querySelectorAll('.color-option');
    colorOptions.forEach(option => {
        option.addEventListener('click', () => {
            colorOptions.forEach(o => o.classList.remove('active'));
            option.classList.add('active');
            selectedColor = option.dataset.color;
        });
    });
}

function createBoard() {
    const title = document.getElementById('board-title').value.trim();
    
    if (!title) {
        Swal.fire({
            icon: 'warning',
            title: getTranslation('please_enter_board_title', 'Please enter a board title'),
            confirmButtonText: getTranslation('ok', 'OK')
        });
        return;
    }

    fetch('http://localhost:8000/boards/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
        },
        body: JSON.stringify({ title, color: selectedColor })
    })
    .then(response => {
        if (!response.ok) throw new Error(getTranslation('failed_create_board', 'Failed to create board'));
        return response.json();
    })
    .then(data => {
        document.getElementById('board-title').value = '';
        loadBoards();
    })
    .catch(error => {
        Swal.fire({
            icon: 'error',
            title: getTranslation('error_creating_board', 'Error creating board'),
            text: error.message,
            confirmButtonText: getTranslation('ok', 'OK')
        });
    });
}

function deleteBoard(event, boardId) {
    event.stopPropagation();
    Swal.fire({
        icon: 'warning',
        title: getTranslation('confirm_delete_board', 'Are you sure you want to delete this board?'),
        showCancelButton: true,
        confirmButtonText: getTranslation('yes', 'Yes'),
        cancelButtonText: getTranslation('no', 'No')
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`http://localhost:8000/boards/${boardId}/`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${accessToken}` }
            })
            .then(response => {
                if (!response.ok) throw new Error(getTranslation('failed_delete_board', 'Failed to delete board'));
                loadBoards();
                if (currentBoardId === boardId) {
                    currentBoardId = null;
                    showBoardSelection();
                }
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: getTranslation('error_deleting_board', 'Error deleting board'),
                    text: error.message,
                    confirmButtonText: getTranslation('ok', 'OK')
                });
            });
        }
    });
}

function openBoard(boardId, boardColor) {
    currentBoardId = boardId;
    currentBoardColor = boardColor;
    localStorage.setItem('lastBoardId', boardId);
    showTrelloBoard();
    loadLists();
}

// List Management
function loadLists() {
    if (!currentBoardId) {
        showBoardSelection();
        return;
    }

    fetch(`http://localhost:8000/lists/boards/${currentBoardId}/lists/`, {
        headers: { 'Authorization': `Bearer ${accessToken}` }
    })
    .then(response => {
        if (!response.ok) {
            if (response.status === 401) {
                logout();
                throw new Error(getTranslation('unauthorized', 'Unauthorized'));
            }
            throw new Error(getTranslation('failed_load_lists', 'Failed to load lists'));
        }
        return response.json();
    })
    .then(data => {
        const listsContainer = document.getElementById('lists-container');
        listsContainer.innerHTML = '';
        
        data.forEach(list => {
            const listElement = createListElement(list);
            listsContainer.appendChild(listElement);
            loadTasks(list.id);
        });
    })
    .catch(error => {
        if (!error.message.includes('Unauthorized')) {
            Swal.fire({
                icon: 'error',
                title: getTranslation('error_loading_lists', 'Error loading lists'),
                text: error.message,
                confirmButtonText: getTranslation('ok', 'OK')
            });
        }
    });
}

function createListElement(list) {
    const listDiv = document.createElement('div');
    listDiv.className = 'list-column';
    listDiv.id = `list-${list.id}`;
    listDiv.innerHTML = `
        <div class="list-header">
            <h6 class="list-title">${list.title}</h6>
            <button class="btn btn-danger btn-sm" onclick="deleteList(event, ${list.id})">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <ul class="task-list" id="task-list-${list.id}"></ul>
        <button class="add-task-btn" onclick="showAddTaskModal(${list.id})">
            <i class="fas fa-plus"></i> ${getTranslation('add_task', 'Add Task')}
        </button>
    `;

    // Setup sortable
    const taskList = listDiv.querySelector('.task-list');
    new Sortable(taskList, {
        group: 'shared',
        animation: 200,
        ghostClass: 'sortable-ghost',
        onEnd: function (evt) {
            const taskId = evt.item.dataset.taskId;
            const newListId = evt.to.id.replace('task-list-', '');
            const newOrder = evt.newIndex;
            moveTask(taskId, newListId, newOrder);
        }
    });

    return listDiv;
}

function showAddListModal() {
    const modal = new bootstrap.Modal(document.getElementById('addListModal'));
    document.getElementById('list-title-input').value = '';
    modal.show();
}

function addList() {
    const title = document.getElementById('list-title-input').value.trim();
    
    if (!title) {
        Swal.fire({
            icon: 'warning',
            title: getTranslation('please_enter_list_title', 'Please enter a list title'),
            confirmButtonText: getTranslation('ok', 'OK')
        });
        return;
    }

    fetch(`http://localhost:8000/lists/boards/${currentBoardId}/lists/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
        },
        body: JSON.stringify({ title })
    })
    .then(response => {
        if (!response.ok) throw new Error(getTranslation('failed_create_list', 'Failed to create list'));
        return response.json();
    })
    .then(() => {
        bootstrap.Modal.getInstance(document.getElementById('addListModal')).hide();
        loadLists();
    })
    .catch(error => {
        Swal.fire({
            icon: 'error',
            title: getTranslation('error_creating_list', 'Error creating list'),
            text: error.message,
            confirmButtonText: getTranslation('ok', 'OK')
        });
    });
}

function deleteList(event, listId) {
    event.stopPropagation();
    Swal.fire({
        icon: 'warning',
        title: getTranslation('confirm_delete_list', 'Are you sure you want to delete this list and all its tasks?'),
        showCancelButton: true,
        confirmButtonText: getTranslation('yes', 'Yes'),
        cancelButtonText: getTranslation('no', 'No')
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`http://localhost:8000/lists/boards/${currentBoardId}/lists/${listId}/`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${accessToken}` }
            })
            .then(response => {
                if (!response.ok) throw new Error(getTranslation('failed_delete_list', 'Failed to delete list'));
                loadLists();
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: getTranslation('error_deleting_list', 'Error deleting list'),
                    text: error.message,
                    confirmButtonText: getTranslation('ok', 'OK')
                });
            });
        }
    });
}

// Task Management
function loadTasks(listId) {
    fetch(`http://localhost:8000/lists/lists/${listId}/tasks/`, {
        headers: { 'Authorization': `Bearer ${accessToken}` }
    })
    .then(response => {
        if (!response.ok) {
            if (response.status === 401) {
                logout();
                throw new Error(getTranslation('unauthorized', 'Unauthorized'));
            }
            throw new Error(getTranslation('failed_load_tasks', 'Failed to load tasks'));
        }
        return response.json();
    })
    .then(data => {
        const taskList = document.getElementById(`task-list-${listId}`);
        taskList.innerHTML = '';
        
        data.forEach(task => {
            const taskElement = createTaskElement(task);
            taskList.appendChild(taskElement);
        });
    })
    .catch(error => {
        if (!error.message.includes('Unauthorized')) {
            Swal.fire({
                icon: 'error',
                title: getTranslation('error_loading_tasks', 'Error loading tasks'),
                text: error.message,
                confirmButtonText: getTranslation('ok', 'OK')
            });
        }
    });
}

function createTaskElement(task) {
    const taskDiv = document.createElement('li');
    taskDiv.className = 'task-card';
    taskDiv.dataset.taskId = task.id;
    taskDiv.onclick = () => showTaskDetails(task);
    
    const dueDate = task.due_date ? new Date(task.due_date).toLocaleDateString() : getTranslation('no_due_date', 'No due date');
    const description = task.description || getTranslation('no_description', 'No description');
    
    taskDiv.innerHTML = `
        <div class="task-title">${task.title}</div>
        <div class="task-meta">
            <span><i class="fas fa-align-left"></i> ${description}</span>
            <span><i class="fas fa-calendar"></i> ${dueDate}</span>
        </div>
    `;
    
    return taskDiv;
}

function showAddTaskModal(listId) {
    currentListId = listId;
    const modal = new bootstrap.Modal(document.getElementById('addTaskModal'));
    document.getElementById('task-title-input').value = '';
    document.getElementById('task-description-input').value = '';
    document.getElementById('task-due-date-input').value = '';
    modal.show();
}

function addTask() {
    const title = document.getElementById('task-title-input').value.trim();
    const description = document.getElementById('task-description-input').value.trim();
    const dueDate = document.getElementById('task-due-date-input').value;
    
    if (!title) {
        Swal.fire({
            icon: 'warning',
            title: getTranslation('please_enter_task_title', 'Please enter a task title'),
            confirmButtonText: getTranslation('ok', 'OK')
        });
        return;
    }

    const taskData = {
        title,
        description: description || '',
        order: 0
    };

    if (dueDate) {
        taskData.due_date = dueDate;
    }

    fetch(`http://localhost:8000/lists/lists/${currentListId}/tasks/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
        },
        body: JSON.stringify(taskData)
    })
    .then(response => {
        if (!response.ok) throw new Error(getTranslation('failed_create_task', 'Failed to create task'));
        return response.json();
    })
    .then(() => {
        bootstrap.Modal.getInstance(document.getElementById('addTaskModal')).hide();
        loadTasks(currentListId);
    })
    .catch(error => {
        Swal.fire({
            icon: 'error',
            title: getTranslation('error_creating_task', 'Error creating task'),
            text: error.message,
            confirmButtonText: getTranslation('ok', 'OK')
        });
    });
}

// Task Details Management
function showTaskDetails(task) {
    currentTaskForDetails = task;
    
    document.getElementById('task-details-title').textContent = task.title;
    document.getElementById('task-details-title-text').textContent = task.title;
    document.getElementById('task-details-description').textContent = task.description || getTranslation('no_description_provided', 'No description provided');
    
    const dueDate = task.due_date ? new Date(task.due_date).toLocaleString() : getTranslation('no_due_date_set', 'No due date set');
    document.getElementById('task-details-due-date').textContent = dueDate;
    
    const listElement = document.getElementById(`list-${task.list}`);
    const listTitle = listElement ? listElement.querySelector('.list-title').textContent : getTranslation('unknown_list', 'Unknown List');
    document.getElementById('task-details-list').textContent = listTitle;
    
    const createdDate = task.created_at ? new Date(task.created_at).toLocaleString() : getTranslation('unknown', 'Unknown');
    document.getElementById('task-details-created').textContent = createdDate;
    
    // Load assigned users
    loadAssignedUsers(task);
    
    const modal = new bootstrap.Modal(document.getElementById('taskDetailsModal'));
    modal.show();
}

async function loadAssignedUsers(task) {
    const assignedUsersContainer = document.getElementById('assigned-users');
    assignedUsersContainer.innerHTML = '';

    let boardMembers = [];
    try {
        const response = await fetch(`http://localhost:8000/boards/${currentBoardId}/`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        if (!response.ok) throw new Error('Failed to load board members');
        const board = await response.json();
        boardMembers = board.members; 
    } catch (error) {
        assignedUsersContainer.innerHTML = `<p class="text-muted">{% trans "Error loading board members" %}</p>`;
        return;
    }

    if (task.assigned_users && task.assigned_users.length > 0) {
        task.assigned_users.forEach(user => {
            const userId = user.id || user; 
            const matchedUser = boardMembers.find(member => member.id === userId);
            const displayName = matchedUser ? (matchedUser.name || matchedUser.username || 'Unknown User') : 'Unknown User';

            const chip = document.createElement('div');
            chip.className = 'assigned-user-chip';
            chip.innerHTML = `
                ${displayName}
                <i class="fas fa-times remove-user" onclick="unassignUser(${task.id}, ${userId})"></i>
            `;
            assignedUsersContainer.appendChild(chip);
        });
    } else {
        assignedUsersContainer.innerHTML = `<p class="text-muted">{% trans "No users assigned" %}</p>`;
    }

    const assignSelect = document.getElementById('assign-users-select');
    assignSelect.innerHTML = '<option value="">{% trans "Select user to assign" %}</option>';

    boardMembers.forEach(user => {
        if (!task.assigned_users || !task.assigned_users.some(u => (u.id || u) === user.id)) {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = user.name || user.username || 'Unknown User';
            assignSelect.appendChild(option);
        }
    });
}

async function assignUser(taskId) {
    const userId = document.getElementById('assign-users-select').value;
    if (!userId) return;

    try {
        const currentAssignedUsers = (currentTaskForDetails.assigned_users || []).map(u => u.id || u);
        const response = await fetch(`http://localhost:8000/lists/lists/${currentTaskForDetails.list}/tasks/${taskId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({ 
                assigned_users: [...currentAssignedUsers, parseInt(userId)] 
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(getTranslation('failed_assign_user', 'Failed to assign user'));
        }

        const updatedTask = await response.json();
        currentTaskForDetails = updatedTask;
        loadAssignedUsers(updatedTask);
        loadTasks(currentTaskForDetails.list);
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: getTranslation('error_assigning_user', 'Error assigning user'),
            text: error.message,
            confirmButtonText: getTranslation('ok', 'OK')
        });
    }
}

async function unassignUser(taskId, userId) {
    try {
        const currentAssignedUsers = (currentTaskForDetails.assigned_users || []).map(u => u.id || u);
        const updatedAssignedUsers = currentAssignedUsers.filter(id => id !== userId);

        const response = await fetch(`http://localhost:8000/lists/lists/${currentTaskForDetails.list}/tasks/${taskId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({ 
                assigned_users: updatedAssignedUsers 
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(getTranslation('failed_unassign_user', 'Failed to unassign user'));
        }

        const updatedTask = await response.json();
        currentTaskForDetails = updatedTask;
        loadAssignedUsers(updatedTask);
        loadTasks(currentTaskForDetails.list);
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: getTranslation('error_unassigning_user', 'Error unassigning user'),
            text: error.message,
            confirmButtonText: getTranslation('ok', 'OK')
        });
    }
}

function deleteTask() {
    if (!currentTaskForDetails) return;
    
    Swal.fire({
        icon: 'warning',
        title: getTranslation('Are you sure you want to delete this task?', 'Are you sure you want to delete this task?'),
        showCancelButton: true,
        confirmButtonText: getTranslation('yes', 'Yes'),
        cancelButtonText: getTranslation('no', 'No')
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`http://localhost:8000/lists/lists/${currentTaskForDetails.list}/tasks/${currentTaskForDetails.id}/`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${accessToken}` }
            })
            .then(response => {
                if (!response.ok) throw new Error(getTranslation('failed_delete_task', 'Failed to delete task'));
                bootstrap.Modal.getInstance(document.getElementById('taskDetailsModal')).hide();
                loadTasks(currentTaskForDetails.list);
                currentTaskForDetails = null;
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: getTranslation('error_deleting_task', 'Error deleting task'),
                    text: error.message,
                    confirmButtonText: getTranslation('ok', 'OK')
                });
            });
        }
    });
}

function moveTask(taskId, newListId, newOrder) {
    fetch(`http://localhost:8000/lists/tasks/${taskId}/move/`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
        },
        body: JSON.stringify({ list_id: parseInt(newListId), order: newOrder })
    })
    .then(response => {
        if (!response.ok) throw new Error(getTranslation('failed_move_task', 'Failed to move task'));
        return response.json();
    })
    .then(() => {
        const affectedLists = new Set([newListId]);
        document.querySelectorAll('.list-column').forEach(list => {
            const listId = list.id.replace('list-', '');
            if (affectedLists.has(listId) || list.querySelector(`[data-task-id="${taskId}"]`)) {
                loadTasks(listId);
            }
        });
    })
    .catch(error => {
        loadLists();
    });
}

// Invite Functions
async function showInviteMemberModal() {
    const modal = new bootstrap.Modal(document.getElementById('inviteMemberModal'));
    document.getElementById('invite-email-input').value = '';
    document.getElementById('invite-error').style.display = 'none';
    
    // Load boards for dropdown
    try {
        const response = await fetch('http://localhost:8000/boards/', {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        if (!response.ok) throw new Error('Failed to load boards');
        const boards = await response.json();
        
        const select = document.getElementById('invite-board-select');
        select.innerHTML = '<option value="">{% trans "Select Board" %}</option>';
        boards.forEach(board => {
            const option = document.createElement('option');
            option.value = board.id;
            option.textContent = board.title;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading boards for invite:', error);
    }
    
    modal.show();
}

async function sendInvitation() {
    const boardId = document.getElementById('invite-board-select').value;
    const email = document.getElementById('invite-email-input').value.trim();
    
    if (!boardId) {
        document.getElementById('invite-error').textContent = getTranslation('please_select_board', 'Please select a board');
        document.getElementById('invite-error').style.display = 'block';
        return;
    }
    
    if (!email) {
        document.getElementById('invite-error').textContent = getTranslation('please_enter_email', 'Please enter an email');
        document.getElementById('invite-error').style.display = 'block';
        return;
    }

    try {
        const response = await fetch('http://localhost:8000/invitations/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({ board: boardId, invited_user_email: email })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || getTranslation('failed_send_invitation', 'This user has already been invited'));
        }

        bootstrap.Modal.getInstance(document.getElementById('inviteMemberModal')).hide();
        Swal.fire({
            icon: 'success',
            title: getTranslation('invitation_sent', 'Invitation sent successfully'),
            confirmButtonText: getTranslation('ok', 'OK')
        });
    } catch (error) {
        document.getElementById('invite-error').textContent = error.message;
        document.getElementById('invite-error').style.display = 'block';
    }
}

function showInvitationsModal() {
    const modal = new bootstrap.Modal(document.getElementById('invitationsModal'));
    loadInvitations();
    modal.show();
}

async function loadInvitations() {
    try {
        const response = await fetch('http://localhost:8000/invitations/', {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });

        if (!response.ok) {
            if (response.status === 401) {
                logout();
                throw new Error(getTranslation('unauthorized', 'Unauthorized'));
            }
            throw new Error(getTranslation('failed_load_invitations', 'Failed to load invitations'));
        }

        const data = await response.json();

        const sentList = document.getElementById('sent-invitations-list');
        const receivedList = document.getElementById('received-invitations-list');
        sentList.innerHTML = '';
        receivedList.innerHTML = '';

        const sentInvitations = data.filter(inv => {
            if (!inv.board) return false;
            const ownerId = inv.board.owner?.id || inv.board.owner;
            return ownerId === userInfo.id;
        });

        const receivedInvitations = data.filter(inv => {
            const invitedUserId = inv.invited_user?.id || inv.invited_user;
            return invitedUserId === userInfo.id;
        });


        sentInvitations.forEach(inv => {
            const boardTitle = inv.board?.title || 'Unknown Board';
            const email = inv.invited_user?.email || inv.invited_user_email || 'invited you';
            const invItem = document.createElement('div');
            invItem.className = 'invitation-item';
            invItem.innerHTML = `
                <div>
                    <strong>${email}</strong> {% trans "to" %} <strong>${boardTitle}</strong>
                    <span class="invitation-status-${inv.status.toLowerCase()}">(${getTranslation(inv.status.toLowerCase(), inv.status)})</span>
                </div>
                <div class="invitation-actions"></div>
            `;
            sentList.appendChild(invItem);
        });

        receivedInvitations.forEach(inv => {
            const boardTitle = inv.board?.title || 'Unknown Board';
            const invItem = document.createElement('div');
            invItem.className = 'invitation-item';
            invItem.innerHTML = `
                <div>
                    <strong>${boardTitle}</strong>
                    <span class="invitation-status-${inv.status.toLowerCase()}">(${getTranslation(inv.status.toLowerCase(), inv.status)})</span>
                </div>
                <div class="invitation-actions">
                    ${inv.status === 'pending' ? `
                        <button class="btn btn-success btn-sm" onclick="acceptInvitation(${inv.id})">
                            <i class="fas fa-check"></i> {% trans "Accept" %}
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="rejectInvitation(${inv.id})">
                            <i class="fas fa-times"></i> {% trans "Reject" %}
                        </button>
                    ` : ''}
                </div>
            `;
            receivedList.appendChild(invItem);
        });

        if (sentInvitations.length === 0) {
            sentList.innerHTML = `<p class="text-muted">{% trans "No sent invitations" %}</p>`;
        }
        if (receivedInvitations.length === 0) {
            receivedList.innerHTML = `<p class="text-muted">{% trans "No received invitations" %}</p>`;
        }
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: getTranslation('error_loading_invitations', 'Error loading invitations'),
            text: error.message,
            confirmButtonText: getTranslation('ok', 'OK')
        });
    }
}

async function acceptInvitation(invitationId) {
    try {
        const response = await fetch(`http://localhost:8000/invitations/${invitationId}/accept/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({ status: 'accepted' })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || getTranslation('failed_accept_invitation', 'Failed to accept invitation'));
        }

        loadInvitations();
        loadBoards(); // Refresh boards to show new board
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: getTranslation('error_accepting_invitation', 'Error accepting invitation'),
            text: error.message,
            confirmButtonText: getTranslation('ok', 'OK')
        });
    }
}

async function rejectInvitation(invitationId) {
    try {
        const response = await fetch(`http://localhost:8000/invitations/${invitationId}/reject/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({ status: 'rejected' })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || getTranslation('failed_reject_invitation', 'Failed to reject invitation'));
        }

        loadInvitations();
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: getTranslation('error_rejecting_invitation', 'Error rejecting invitation'),
            text: error.message,
            confirmButtonText: getTranslation('ok', 'OK')
        });
    }
}

// Function to change language and refresh
function changeLanguage(lang) {
    localStorage.setItem('userLanguage', lang);
    window.location.href = '/' + lang + window.location.pathname.replace(/^\/[a-z]{2}/, '');
}

async function showUserProfileModal() {
    const modal = new bootstrap.Modal(document.getElementById('userProfileModal'));
    
    try {
        const response = await fetch('http://localhost:8000/users/profile/', {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });

        if (!response.ok) {
            throw new Error(getTranslation('failed_load_profile', 'Failed to load profile'));
        }

        const userData = await response.json();
        
        document.getElementById('profile-username').textContent = userData.username || getTranslation('no_username', 'No username');
        document.getElementById('profile-email').textContent = userData.email || getTranslation('no_email', 'No email');
        document.getElementById('profile-name').textContent = userData.name || getTranslation('no_name', 'No name');
        document.getElementById('profile-language').textContent = userData.preferred_language || getTranslation('no_language', 'No language');
        
        modal.show();
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: getTranslation('error_loading_profile', 'Error loading profile'),
            text: error.message,
            confirmButtonText: getTranslation('ok', 'OK')
        });
    }
}

// Initialize app when page loads
document.addEventListener('DOMContentLoaded', async () => {
    await initApp();
    
    // Check for last viewed board
    const lastBoardId = localStorage.getItem('lastBoardId');
    if (lastBoardId && accessToken) {
        try {
            const response = await fetch(`http://localhost:8000/boards/${lastBoardId}/`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            
            if (response.ok) {
                const board = await response.json();
                openBoard(board.id, board.color);
            } else {
                throw new Error('Board not found');
            }
        } catch (error) {
            showBoardSelection();
        }
    }
});

// Handle Enter key for forms
document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        const activeModal = document.querySelector('.modal.show');
        if (activeModal) {
            if (activeModal.id === 'addListModal') {
                addList();
            } else if (activeModal.id === 'addTaskModal') {
                addTask();
            } else if (activeModal.id === 'inviteMemberModal') {
                sendInvitation();
            }
        } else if (document.getElementById('login-card').style.display === 'block') {
            login();
        } else if (document.getElementById('register-card').style.display === 'block') {
            register();
        }
    }
});
</script>

</body>
</html>